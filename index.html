<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>집꾸미기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link href="main.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar menu">
        <div class="container-fluid">
            <div class="row row-cols-auto navbar-collapse">
                <div class="col"><a class="navbar-brand me-0" href="#">집꾸미기</a></div>
                <div class="col"><a class="nav-link" href="#">Home</a></div>
                <div class="col"><a class="nav-link" href="#">스토어</a></div>
                <div class="col"><a class="nav-link" href="#">시공견적</a></div>
            </div>
        </div>
    </nav>

    <form class="search-form">
        <input placeholder="검색어 입력" id="search">
    </form>

    <br>


    <div class="container">
        <div class="row gx-5" id="merch"></div>
    </div>

    <script>
        var rowDiv = $('#merch');
        var allData;

        function renderItem(items) {
            items.forEach((data) => {
                rowDiv.append(`<div class="col-3" draggable="true" id="${data.id}" ondragstart="dragstartHandler(event)">
                                    <div class=card>
                                        <img src="./img/${data.photo}" class="card-img-top">
                                        <div class="card-body">
                                            <h5 class="fw-bold">${data.title}</h5>
                                            <p class="card-brand">${data.brand}</p>
                                            <p>가격 : ${data.price}</p>
                                            <button class="btn btn-dark" id="btn${data.id}">담기</button>
                                        </div>
                                    </div>
                               </div>`);
                document.getElementById('btn' + data.id).addEventListener('click', () => addBucket(data.id));
            })
        }

        function dragstartHandler(e) {
            e.dataTransfer.setData("key", e.target.id);
        }

        function deleteItem() {
            rowDiv.html('');
        }

        $.get('store.json').done((a) => {
            allData = a.products;
            renderItem(allData);
        })

        document.getElementById('search').addEventListener('input', (e) => {
            if(e.target.value == '') {
                deleteItem();
                renderItem(allData);
            }
            else {
                let searchData = [];
                allData.forEach((i) => {
                    var data = JSON.parse(JSON.stringify(i));
                    var find = false;
                    if(i.title.includes(e.target.value)) {
                        data.title = data.title.replace(e.target.value, '<span style="background:yellow">' + e.target.value + '</span>');
                        searchData.push(data);
                        find = true;
                    }
                    if(i.brand.includes(e.target.value)) {
                        data.brand = data.brand.replace(e.target.value, '<span style="background:yellow">' + e.target.value + '</span>');
                        if(!find) {
                            searchData.push(data);
                        }
                    }
                })
                deleteItem();
                renderItem(searchData);
            }
            console.log(allData);
        })
    </script>

    <div class="container bg-e2 w-100 mt-4 mb-2 p-5">
        <h5 class="fw-bold m-2">장바구니</h3>
        <div class="bucket row gx-5" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)"></div>
        <h5 class="fw-bold m-2">합계</h3>
        <p><span id="sum"></span> 원</p>
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#purchaseModal" id="complete">구매하기</button>
    </div>



    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="purchaseModalLabel">구매 정보 입력</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 class="fw-bold m-2">이름</h5>
                    <input id="name">
                    <h5 class="fw-bold m-2">연락처</h5>
                    <input id="phone">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-dark" id="purchase">입력완료</button>
                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var bucket = $(".bucket");
        var sum = $('#sum');
        var empty = true;
        var currBucket = []
        var price = 0;

        function initBucket() {
            bucket.html('<p class="fw-bold" style="text-align: center">여기로 드래그</p>');
        }
        initBucket();

        function sumPrice() {
            price = 0;
            if(empty) {
                sum.html(price);
            }
            else {
                currBucket.forEach((id) => {
                    allData.forEach((data) => {
                        if(data.id == id) {
                            price = price + (data.price * document.getElementById('cnt' + id).value)
                        }
                    })
                })
                sum.html(price);
            }
        }
        sumPrice();

        function dragoverHandler(e) {
            e.preventDefault();
        }

        function dropHandler(e) {
            e.preventDefault();
            const buy = e.dataTransfer.getData("key");
            addBucket(buy);
        }

        function addBucket(id) {
            if(empty) {
                bucket.html('');
                empty = false;
            }
            var already = false;
            
            currBucket.forEach((data) => {
                if(data == id)
                    already = true;
            })
            
            if(!already) {
                var item
                allData.forEach((i) => {
                    if(i.id == id) {
                        item = JSON.parse(JSON.stringify(i));
                    }
                })

                currBucket.push(item.id);
                bucket.append(`<div class="col-3" id="bucket${item.id}">
                                        <div class=card>
                                            <img src="./img/${item.photo}" class="card-img-top">
                                            <div class="card-body">
                                                <h5 class="fw-bold">${item.title}</h5>
                                                <p class="card-brand">${item.brand}</p>
                                                <p>가격 : ${item.price}</p>
                                                <input type="number" id="cnt${item.id}" value="1" style="width:100%">
                                            </div>
                                        </div>
                                </div>`)

                document.getElementById('cnt' + item.id).addEventListener('input', (e) => {
                    sumPrice();
                    if(e.target.value < 1) {
                        document.getElementById('bucket' + id).remove();
                        currBucket = currBucket.filter(j => j != id);
                        if(currBucket.length < 1) {
                            initBucket();
                            empty = true;
                        }
                            
                    }
                })
            }
            else {
                document.getElementById('cnt' + id).value++;
            }
            sumPrice();
            
        }

        $('#purchaseModal').on('show.bs.modal', (e) => {
            if(empty) {
                alert('구매 목록이 비었습니다.');
                e.preventDefault();
                e.stopPropagation();
            }
        })
        
    </script>

    <div class="reciept" style="display:none" id="reciept">
        <canvas id="canvas" width="350" height="400"></canvas>
        <div style="width: 100%; border-top: 1px solid grey; height: 60px">
            <button id="recieptClose" class="btn btn-dark ms-2 mb-2 mt-2">닫기</button>
        </div>
    </div>
    

    <script>
        document.getElementById('purchase').addEventListener('click', () => {
            if(document.getElementById('name').value.trim() === '' || document.getElementById('phone').value.trim() === '') {
                alert('이름과 연락처를 모두 입력해야 합니다.');
                return;
            }

            $('#purchaseModal').modal('hide');

            var canvas = document.getElementById('canvas');
            canvas.height = (currBucket.length * 150) + 300;
            var c = canvas.getContext('2d');
            c.font = 'bold 25px Arial, sans-serif';
            c.fillText('영수증', 15, 28);

            const now = new Date();
            c.font = '14px Arial, sans-serif';
            c.fillText(now, 15, 50);
            c.fillText('구매자: ' + document.getElementById('name').value, 15, 70);
            c.fillText('연락처: ' + document.getElementById('phone').value, 15, 90);
            var y = 0;
            currBucket.forEach((id, index) => {
                y = 150 + (index * 150);
                allData.forEach((data) => {
                    if(data.id == id) {
                        cnt = document.getElementById('cnt' + id).value
                        c.fillText(data.title, 15, y);
                        c.fillText(data.brand, 15, y+20);
                        c.fillText('가격: ' + data.price + ' 원', 15, y+40);
                        c.fillText('수량: ' + cnt + ' 개', 15, y+60);
                        c.fillText('합계: ' + cnt * data.price + ' 원', 15, y+80);
                    }
                })
            })
            c.font = 'bold 20px Arial, sans-serif'
            c.fillText('총 합계 : ' + price + ' 원', 15, y + 220);
            document.getElementById('reciept').style.display = 'block';
        })

        document.getElementById('recieptClose').addEventListener('click', () => {
            document.getElementById('reciept').style.display = 'none';
        })
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>